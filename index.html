<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>City-States Dynasty</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
:root { --text: #e6edf7; --accent: #7dd3fc; --pink: #ff10f0; --cyan: #00f0ff; --good: #34d399; }
* { box-sizing: border-box; }
html, body { margin: 0; padding: 0; font-family: 'Press Start 2P', monospace; background: linear-gradient(135deg, #0a0e1a, #1a0f2e, #0a1a2e); color: var(--text); overflow-x: hidden; }
video#bgVideo { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; z-index: 0; }
.screen { display: none; position: relative; z-index: 10; min-height: 100vh; }
.screen.active { display: flex; flex-direction: column; }
#titleScreen { align-items: center; justify-content: center; }
.arcade-box { border: 4px solid var(--cyan); box-shadow: 0 0 30px var(--cyan); padding: 40px; background: rgba(10, 14, 26, 0.97); text-align: center; max-width: 700px; }
.arcade-title { font-size: 56px; color: var(--cyan); text-shadow: 0 0 20px var(--cyan); margin: 10px 0; letter-spacing: 2px; }
.arcade-subtitle { font-size: 16px; color: var(--pink); text-shadow: 0 0 10px var(--pink); margin: 20px 0 40px 0; }
.arcade-btn { background: linear-gradient(135deg, var(--cyan), var(--pink)); border: 3px solid var(--cyan); color: #000; padding: 15px 40px; margin: 15px; font-size: 14px; font-family: 'Press Start 2P', monospace; cursor: pointer; box-shadow: 0 0 20px var(--cyan); }
.arcade-btn:hover { box-shadow: 0 0 40px var(--cyan), 0 0 60px var(--pink); transform: scale(1.05); }
.container { max-width: 1400px; margin: 0 auto; padding: 18px; position: relative; z-index: 10; }
header { background: linear-gradient(180deg, rgba(15,22,32,.97), rgba(13,19,31,.93)); border: 2px solid var(--accent); padding: 16px 20px; border-radius: 8px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
h1 { font-size: 18px; margin: 0; }
.header-info { font-size: 9px; color: #a8b3c7; margin-top: 4px; }
.layout { display: grid; grid-template-columns: 1.3fr 0.7fr; gap: 16px; }
@media (max-width: 1000px) { .layout { grid-template-columns: 1fr; } }
.card { background: linear-gradient(180deg, rgba(15,22,32,.97), rgba(13,19,31,.93)); border: 1px solid rgba(255,255,255,.1); border-radius: 8px; overflow: hidden; }
.card-header { background: rgba(0,0,0,.2); border-bottom: 1px solid rgba(255,255,255,.1); padding: 12px 16px; font-size: 12px; font-weight: 700; }
.card-body { padding: 16px; }
h2 { font-size: 16px; font-weight: 700; margin: 0 0 10px 0; }
p { font-size: 12px; line-height: 1.6; margin: 0 0 12px 0; }
.video-player { width: 100%; background: #000; border-radius: 8px; border: 2px solid var(--accent); overflow: hidden; margin-bottom: 16px; display: none; box-shadow: 0 0 20px rgba(125,211,252,.3); }
.video-player.show { display: block; }
.video-player video { width: 100%; height: auto; min-height: 360px; display: block; background: #000; }
.choice-btn { width: 100%; background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.1); border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; text-align: left; transition: all 0.15s; color: var(--text); font-family: 'Press Start 2P', monospace; }
.choice-btn:hover { background: rgba(255,255,255,.08); border-color: rgba(125,211,252,.4); box-shadow: 0 0 15px rgba(125,211,252,.2); }
.choice-title { font-size: 12px; font-weight: 700; margin: 0 0 4px 0; }
.choice-desc { font-size: 11px; color: #a8b3c7; margin: 0 0 6px 0; }
.impacts { font-size: 10px; display: flex; flex-wrap: wrap; gap: 6px; }
.impact { background: rgba(0,0,0,.2); padding: 2px 6px; border-radius: 4px; }
.stat-item { background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.1); border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 11px; }
.stat-bar { width: 100%; height: 8px; background: rgba(255,255,255,.06); border-radius: 4px; overflow: hidden; margin-top: 6px; }
.stat-fill { height: 100%; background: linear-gradient(90deg, #7dd3fc, #34d399); transition: width 0.3s; }
.leaderboard { background: rgba(0,0,0,.2); border: 1px solid var(--accent); border-radius: 6px; padding: 8px; }
.lb-row { display: flex; justify-content: space-between; padding: 6px; border-bottom: 1px solid rgba(255,255,255,.05); font-size: 10px; }
.lb-row.gold { color: var(--good); font-weight: 700; }
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.95); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal.open { display: flex; }
.modal-box { background: linear-gradient(180deg, rgba(15,22,32,.99), rgba(13,19,31,.96)); border: 1px solid rgba(255,255,255,.1); border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
input, select { width: 100%; padding: 10px; margin: 8px 0; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.1); color: var(--text); border-radius: 6px; font-family: system-ui; font-size: 11px; }
.btn-group { display: flex; gap: 10px; margin-top: 16px; }
.btn-group button { flex: 1; background: rgba(125,211,252,.16); border: 1px solid rgba(125,211,252,.35); color: var(--text); padding: 12px; border-radius: 6px; cursor: pointer; font-family: 'Press Start 2P', monospace; font-size: 10px; font-weight: 600; }
.btn-group button:hover { background: rgba(125,211,252,.24); }
.final-box { text-align: center; padding: 20px; background: rgba(125,211,252,.1); border-radius: 8px; margin-bottom: 20px; }
.ruler-title { font-size: 18px; color: var(--cyan); margin: 10px 0; }
.ruler-desc { font-size: 12px; color: var(--pink); margin: 0 0 15px 0; }
.score-num { font-size: 32px; font-weight: 700; color: var(--good); }
</style>
</head>
<body>

<video id="bgVideo" autoplay muted loop playsinline>
  <source src="videos/background.mp4" type="video/mp4">
</video>

<!-- TITLE -->
<div id="titleScreen" class="screen active">
  <div class="arcade-box">
    <div class="arcade-title">CITY-STATES</div>
    <div class="arcade-title" style="color: var(--pink);">DYNASTY</div>
    <div class="arcade-subtitle">Build Your Ancient Legacy</div>
    <button class="arcade-btn" id="btnPlay">‚ñ∂ START GAME</button>
    <button class="arcade-btn" id="btnInfo">‚ùì HOW TO PLAY</button>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen" class="screen">
  <div class="container">
    <header>
      <div>
        <h1 id="cityDisplay">City-States Dynasty</h1>
        <div class="header-info" id="infoDisplay">Start a new game</div>
      </div>
      <div style="display: flex; gap: 8px;">
        <button style="background:rgba(125,211,252,.16);border:1px solid rgba(125,211,252,.35);color:var(--text);padding:8px 12px;font-size:10px;cursor:pointer;border-radius:6px;" id="btnRpt">üìã</button>
        <button style="background:rgba(125,211,252,.16);border:1px solid rgba(125,211,252,.35);color:var(--text);padding:8px 12px;font-size:10px;cursor:pointer;border-radius:6px;" id="btnLeader">üèÜ</button>
      </div>
    </header>

    <div class="layout">
      <div>
        <div class="card">
          <div class="card-body">
            <div id="videoBox" class="video-player">
              <video id="gameVid" controls playsinline preload="auto">
                <source id="vidSrc" type="video/mp4">
              </video>
            </div>

            <h2 id="titleDisplay">Loading...</h2>
            <p id="descDisplay"></p>
            <div id="choicesBox"></div>
          </div>
        </div>
      </div>

      <div>
        <!-- LEADERBOARD -->
        <div class="card">
          <div class="card-header">üèÜ LIVE LEADERBOARD</div>
          <div class="leaderboard" id="leaderboardBox"></div>
        </div>

        <!-- STATS -->
        <div class="card" style="margin-top: 14px;">
          <div class="card-header">üìä STATS</div>
          <div class="card-body" id="statsBox"></div>
        </div>

        <!-- LOG -->
        <div class="card" style="margin-top: 14px;">
          <div class="card-header">üìú LOG</div>
          <div class="card-body" id="logBox" style="max-height: 150px; overflow-y: auto; font-size: 10px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SETUP MODAL -->
<div id="setupMod" class="modal">
  <div class="modal-box">
    <h2>‚öîÔ∏è CREATE YOUR DYNASTY</h2>
    <select id="inHour">
      <option>1st Hour</option>
      <option>2nd Hour</option>
      <option>5th Hour</option>
      <option>6th Hour</option>
    </select>
    <input id="inName" type="text" placeholder="Your Name">
    <input id="inCity" type="text" placeholder="City Name">
    <div class="btn-group">
      <button id="btnStart">‚ñ∂ BEGIN</button>
      <button id="btnLoad">‚Ü∫ LOAD</button>
    </div>
  </div>
</div>

<!-- REPORT MODAL -->
<div id="reportMod" class="modal">
  <div class="modal-box">
    <div id="reportBox" style="font-size: 11px;"></div>
    <div class="btn-group" style="margin-top: 20px;">
      <button id="btnDL">üíæ DOWNLOAD</button>
      <button id="btnCloseReport">‚úï CLOSE</button>
    </div>
  </div>
</div>

<!-- LEADERBOARD MODAL -->
<div id="leaderMod" class="modal">
  <div class="modal-box">
    <h2>üèÜ HOUR RANKINGS</h2>
    <div id="leaderFullBox" style="font-size: 11px;"></div>
    <button style="width: 100%; background:rgba(125,211,252,.16);border:1px solid rgba(125,211,252,.35);color:var(--text);padding:10px;border-radius:6px;cursor:pointer;font-family:'Press Start 2P',monospace;font-size:9px;margin-top:10px;" id="btnCloseLead">‚úï CLOSE</button>
  </div>
</div>

<script>
// Airtable Configuration
const AIRTABLE_TOKEN = 'patshU0L6NyIoJdwL.d4460186f260df3a500a686b0f91fd47c11b520b45a4012e77598af4006141ed';
const AIRTABLE_BASE = 'appISJc5UZF8MMJvA';
const AIRTABLE_TABLE = 'tblOVy5SkWmnCmsRl';

function submitToAirtable(hour, name, city, score) {
  const url = `https://api.airtable.com/v0/${AIRTABLE_BASE}/${AIRTABLE_TABLE}`;
  const data = {
    records: [{
      fields: {
        'Hour': hour,
        'Student': name,
        'City': city,
        'Score': score
      }
    }]
  };

  // Log attempt to page
  const logDiv = document.createElement('div');
  logDiv.style.cssText = 'position:fixed;bottom:10px;right:10px;background:#333;color:#fff;padding:10px;border-radius:5px;font-size:11px;z-index:9999;';
  logDiv.innerHTML = `Submitting to Airtable...<br>Hour: ${hour}<br>Name: ${name}<br>Score: ${score}`;
  document.body.appendChild(logDiv);

  fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${AIRTABLE_TOKEN}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(r => {
    logDiv.innerHTML = `Status: ${r.status}<br>Checking response...`;
    return r.json();
  })
  .then(d => {
    logDiv.innerHTML = `‚úì SUCCESS!<br>Data sent to Airtable`;
    logDiv.style.background = '#0a0';
    setTimeout(() => logDiv.remove(), 5000);
  })
  .catch(e => {
    logDiv.innerHTML = `‚úó ERROR:<br>${e.message}`;
    logDiv.style.background = '#a00';
  });
}

const STATS = [{k:"fd",n:"Food",i:"üåæ",v:50},{k:"gd",n:"Gold",i:"üí∞",v:50},{k:"ml",n:"Military",i:"‚öîÔ∏è",v:50},{k:"ct",n:"Culture",i:"üé≠",v:50},{k:"hp",n:"Happiness",i:"üòä",v:60},{k:"sc",n:"Science",i:"üî¨",v:40}];

const ISSUES = [
  {id:"pw",t:"The Poisoned Well",d:"Your city's main water source has been poisoned. Bodies are piling up in the streets - children, elderly, and strong men alike. Your physicians are baffled. Panic spreads through the markets. The people whisper that a rival kingdom did this on purpose. You must act fast or face a full-scale epidemic.",v:"videos/illness.mp4",c:[
    {t:"Close the well & distribute emergency water",d:"Expensive containment",x:{gd:-25,hp:10,fd:-5}},{t:"Execute a scapegoat",d:"Quick but brutal",x:{hp:-30,ct:-20,ml:10}},{t:"Open the gates - let people flee",d:"Merciful but weak",x:{hp:-25,ml:-10,fd:10}}
  ]},
  {id:"cc",t:"The Court Conspiracy",d:"Three of your nobles are found meeting in secret at night. Your spy network reports they're planning to overthrow you - they believe your rule is weak. You have evidence, but it's unclear. Your military commander says execute them now. Your advisor says investigate. Your mother says forgive them and win their loyalty.",v:"videos/conspiracy.mp4",c:[
    {t:"Execute them immediately as traitors",d:"Sends a message of strength",x:{hp:-25,ct:-20,ml:15}},{t:"Publicly investigate and hold a trial",d:"Takes time but appears just",x:{gd:-15,sc:10,hp:5}},{t:"Secretly pardon them & offer honors",d:"Wins allies but looks weak",x:{gd:-10,hp:20,ct:15}}
  ]},
  {id:"ps",t:"The Plague Ship Arrives",d:"A trading vessel arrives at your port with sailors covered in strange black boils. The captain says it's just food poisoning from bad meat. But your healers recognize the unmistakable signs of plague - the deadliest disease known. You have minutes to decide: let them dock and risk everything, or turn away the ship and lose a crucial trade partner.",v:"videos/plague_ship.mp4",c:[
    {t:"Allow the ship to dock - isolation protocol",d:"Economic benefit but health risk",x:{hp:-20,gd:20,sc:10}},{t:"Burn the ship and kill everyone aboard",d:"Brutal but completely stops plague",x:{hp:-40,ct:-30,sc:25}},{t:"Quarantine the ship on an island for 40 days",d:"Balanced approach, scientific method",x:{gd:-20,hp:5,sc:15}}
  ]},
  {id:"ub",t:"The Uprising Begins",d:"Factory workers have had enough. They're storming the city center with torches and weapons, demanding 8-hour workdays instead of 16, and better pay. There are thousands of them - your guards are outnumbered 100 to 1. The wealthy merchants are demanding you crush the rebellion. The workers say if you don't listen, they'll burn the city down.",v:"videos/labor.mp4",c:[
    {t:"Grant all their demands immediately",d:"Expensive but prevents violence",x:{gd:-30,hp:30,ct:20}},{t:"Use the military to violently disperse them",d:"Regains control but creates enemies",x:{hp:-40,ct:-35,ml:20}},{t:"Meet with worker leaders & compromise",d:"Takes time but sustainable",x:{gd:-15,hp:15,ct:10}}
  ]},
  {id:"sc",t:"The Succession Crisis",d:"Your elderly king is dying. He has three children - your eldest son is wise but weak, your daughter is brilliant but women aren't accepted as rulers, your youngest is charming but foolish. The nobles are divided. Some want your son. Some secretly support your daughter. Your youngest is bribing generals. You must choose the next ruler, and your choice will shape the kingdom for generations.",v:"videos/succession.mp4",c:[
    {t:"Choose the eldest son (tradition)",d:"Follows tradition but less capable",x:{hp:15,ct:10,sc:-5}},{t:"Choose the daughter (revolutionary)",d:"Progressive but controversial",x:{ct:-20,hp:-15,sc:25}},{t:"Create a council - let all three rule together",d:"Compromise but unstable",x:{hp:10,ct:15,ml:-10}}
  ]},
  {id:"rs",t:"The Religious Schism",d:"A charismatic preacher has emerged claiming the old gods are false and demanding radical reform. Half your people follow him. The other half - especially the priests - see him as a heretic who will destroy your culture. Riots are breaking out in temples. You're being asked to either execute the preacher or ban traditional religion. Either way, blood will spill.",v:"videos/religion.mp4",c:[
    {t:"Execute the preacher as a heretic",d:"Maintains tradition but creates a martyr",x:{hp:-25,ct:-15,ml:5}},{t:"Ban traditional religion & support the reformer",d:"Modern but alienates traditions",x:{ct:-30,hp:-20,sc:20}},{t:"Allow both religions to coexist peacefully",d:"Enlightened but both sides unhappy",x:{ct:-5,hp:10,sc:15}}
  ]},
  {id:"fd",t:"The Famine Deepens",d:"Two years of drought have left your granaries nearly empty. Your people are starving. Food prices have tripled. Your neighboring kingdom has offered to sell you grain - but at a price that will bankrupt you. Your generals suggest raiding a weaker neighbor for food. Your advisors suggest declaring a 'famine tax' on the wealthy to buy emergency supplies.",v:"videos/famine.mp4",c:[
    {t:"Buy grain from neighbors at any cost",d:"Saves people but economic disaster",x:{gd:-40,hp:25,fd:20}},{t:"Raid a neighboring kingdom for supplies",d:"Solves problem but makes enemies",x:{hp:10,ml:20,ct:-25}},{t:"Tax the wealthy & ration food fairly",d:"Fair and sustainable but slow",x:{gd:-15,hp:15,ct:20}}
  ]},
  {id:"tb",t:"The Technological Breakthrough",d:"Your engineers have invented a revolutionary new plow that can increase crop yields by 50%. But it requires metal - lots of it - which must be mined from sacred land that your people consider holy. The priests say mining it will curse your kingdom. The farmers say they'll starve without the new plow. Your scientists say the curse is superstition.",v:"videos/technology.mp4",c:[
    {t:"Mine the sacred land - progress over tradition",d:"Economic boom but cultural crisis",x:{ct:-25,hp:-20,fd:30,sc:20}},{t:"Respect the sacred land - tradition over progress",d:"Keeps peace but misses opportunity",x:{fd:-15,hp:20,ct:25}},{t:"Find alternative materials for the plow",d:"Balanced but expensive and slow",x:{sc:15,gd:-20,hp:10}}
  ]},
  {id:"wr",t:"The Women's Rebellion",d:"Women are demanding equal rights - the right to own property, work certain jobs, vote on important decisions. Half your kingdom supports them. The other half (mostly traditional men) sees this as the end of civilization. Protests are turning violent. Your military is split on whether to protect the protesters or suppress them.",v:"videos/women.mp4",c:[
    {t:"Grant women full equality",d:"Modern but controversial",x:{hp:30,ct:25,gd:10}},{t:"Maintain traditional laws",d:"Safe but unjust",x:{hp:-25,ct:-20,ml:15}},{t:"Limited reforms - gradual change",d:"Compromise but everyone upset",x:{hp:10,ct:5,gd:-5}}
  ]},
  {id:"bt",t:"The Border Threat",d:"Your neighbor has amassed 50,000 soldiers at your border. They're demanding you surrender your richest province or they'll invade. You have 20,000 soldiers. Your merchants say the province is worth less than a war would cost. Your generals say surrender is humiliation. Your people are terrified.",v:"videos/border.mp4",c:[
    {t:"Surrender the province to avoid war",d:"Pragmatic but shameful",x:{hp:-30,ct:-25,gd:20}},{t:"Prepare for war - defend the province",d:"Risky but honorable",x:{ml:30,gd:-40,hp:0}},{t:"Negotiate - trade something less valuable for peace",d:"Diplomatic solution",x:{hp:5,gd:-10,ct:10}}
  ]},
  {id:"eg",t:"The Exploration Gamble",d:"Your explorers have returned with news of undiscovered lands beyond the sea - possibly containing gold, spices, and new trade routes. But the journey is deadly - 2 out of 3 ships are expected to be lost. The venture will cost your treasury dearly. But if successful, it could make you the richest kingdom in the world.",v:"videos/exploration.mp4",c:[
    {t:"Fund the expedition massively",d:"Ambitious but potentially ruinous",x:{gd:-50,sc:30,ct:10}},{t:"Send a small, cautious expedition",d:"Safe but limited reward",x:{gd:-15,sc:10,hp:5}},{t:"Don't fund exploration - focus on home",d:"Stable but no progress",x:{gd:10,hp:5,sc:-10}}
  ]},
  {id:"ar",t:"The Artistic Renaissance",d:"A great artist has arrived in your city - someone whose works will be remembered for centuries. But supporting true art is expensive. The wealthy want to buy their portraits. The poor want bread. Your treasury can't support both. You must choose: fund the arts and inspire your people, or feed the hungry and be seen as practical.",v:"videos/arts.mp4",c:[
    {t:"Fund the artist lavishly",d:"Creates legacy but ignores suffering",x:{hp:-20,ct:40,gd:-30}},{t:"Ignore the artist & feed the poor",d:"Practical but misses greatness",x:{hp:20,ct:-15,gd:-20}},{t:"Compromise - modest support & feeding people",d:"Balanced approach",x:{hp:5,ct:15,gd:-20}}
  ]},
  {id:"tm",t:"The Trade Monopoly War",d:"A powerful merchant guild has become too powerful - they're controlling all trade, setting prices, and becoming richer than the crown. They're bribing your officials and threatening to leave your city if you regulate them. If they leave, your economy collapses. If you let them continue, they'll eventually control your kingdom.",v:"videos/trade.mp4",c:[
    {t:"Break up the guild by force",d:"Regains control but destroys economy",x:{gd:-40,ml:15,hp:-20}},{t:"Tax them heavily & regulate prices",d:"Balance power and profit",x:{gd:30,hp:20,ct:10}},{t:"Grant them more power in exchange for loyalty",d:"Wealthy but become their puppet",x:{gd:50,hp:-30,ct:-20}}
  ]},
  {id:"q1",t:"Geography: Southwest Border",d:"Which country is directly southwest of Saudi Arabia?",v:"videos/geography.mp4",c:[
    {t:"Yemen",d:"",x:{sc:15}},{t:"Oman",d:"",x:{sc:0}},{t:"UAE",d:"",x:{sc:0}}
  ]},
  {id:"q2",t:"Geography: Eastern Border",d:"Which country borders Iran to the east?",v:"videos/geography.mp4",c:[
    {t:"Afghanistan",d:"",x:{sc:15}},{t:"Pakistan",d:"",x:{sc:0}},{t:"Turkmenistan",d:"",x:{sc:0}}
  ]},
  {id:"q3",t:"Geography: Eastern Neighbor",d:"Which country is directly east of Iraq?",v:"videos/geography.mp4",c:[
    {t:"Iran",d:"",x:{sc:15}},{t:"Syria",d:"",x:{sc:0}},{t:"Kuwait",d:"",x:{sc:0}}
  ]},
  {id:"q4",t:"Geography: Across the Gulf",d:"Which country is directly across the Persian Gulf from Iran?",v:"videos/geography.mp4",c:[
    {t:"Saudi Arabia",d:"",x:{sc:15}},{t:"Qatar",d:"",x:{sc:0}},{t:"Bahrain",d:"",x:{sc:0}}
  ]},
  {id:"q5",t:"Geography: Northern Border",d:"Which country borders Turkey to the north?",v:"videos/geography.mp4",c:[
    {t:"Georgia",d:"",x:{sc:15}},{t:"Russia",d:"",x:{sc:0}},{t:"Bulgaria",d:"",x:{sc:0}}
  ]},
  {id:"q6",t:"Geography: Western Neighbor",d:"Which country is directly west of Jordan?",v:"videos/geography.mp4",c:[
    {t:"Israel",d:"",x:{sc:15}},{t:"Syria",d:"",x:{sc:0}},{t:"Lebanon",d:"",x:{sc:0}}
  ]},
  {id:"q7",t:"Geography: Southern Border",d:"Which country is directly south of Israel?",v:"videos/geography.mp4",c:[
    {t:"Egypt",d:"",x:{sc:15}},{t:"Saudi Arabia",d:"",x:{sc:0}},{t:"Jordan",d:"",x:{sc:0}}
  ]}
];

let G={nm:"",cy:"",hr:"",tu:0,mx:20,dn:0,st:{},nb:[{n:"Corinth",r:50},{n:"Thebes",r:45},{n:"Sparta",r:40}],lg:[],us:[],cr:0};

function save(){localStorage.setItem("CS_"+G.hr,JSON.stringify(G));}
function load(){const x=localStorage.getItem("CS_"+G.hr);if(x)try{G=JSON.parse(x);}catch{}}
function norm(){STATS.forEach(s=>{if(!G.st[s.k])G.st[s.k]=s.v;});save();}
function next(){const a=ISSUES.filter(x=>!G.us.includes(x.id));if(!a.length){G.dn=1;save();return null;}const i=a[Math.floor(Math.random()*a.length)];G.us.push(i.id);return i;}
function score(){const h=G.st.hp||60,c=G.st.ct||50,s=G.st.sc||40,m=G.st.ml||50,g=G.st.gd||50;return Math.round((h+c+s+m+g)/5);}
function ruler(){const h=G.st.hp||60,c=G.st.ct||50,s=G.st.sc||40,m=G.st.ml||50,g=G.st.gd||50,avg=(h+c+s+m+g)/5;if(h>=80&&c>=60)return{t:"BENEVOLENT RULER",d:"Your compassion and wisdom brought prosperity."};if(m>=85&&h<=40)return{t:"IRON TYRANT",d:"Fear ruled your dynasty."};if(s>=80&&c>=75)return{t:"RENAISSANCE PATRON",d:"Knowledge and culture flourished."};if(avg>=70)return{t:"GREAT RULER",d:"You balanced all aspects."};if(h<=30&&m>=80)return{t:"BRUTAL DICTATOR",d:"Your people suffered."};return{t:"MEDIOCRE RULER",d:"Your reign was forgettable."};}

function setScenarioVideo(src){
  const vid=document.getElementById("gameVid");
  const source=document.getElementById("vidSrc");
  const box=document.getElementById("videoBox");
  
  if(!src){
    try{vid.pause();}catch{};
    box.classList.remove("show");
    return;
  }
  
  box.classList.add("show");
  try{vid.pause();}catch{};
  source.src=src;
  vid.load();
  try{vid.currentTime=0;}catch{};
  const p=vid.play();
  if(p&&typeof p.catch==="function"){p.catch(()=>{});}
}

function choose(i){
  if(G.dn||!G.cr)return;
  const iss=ISSUES.find(x=>x.id===G.cr);
  if(!iss||!iss.c[i])return;
  const o=iss.c[i];
  G.tu++;
  G.lg.push({t:G.tu,ch:o.t});
  Object.entries(o.x||{}).forEach(([k,v])=>{if(G.st[k]!==undefined)G.st[k]=Math.max(0,Math.min(100,G.st[k]+v));});
  if(Math.random()<0.4){const idx=Math.floor(Math.random()*G.nb.length);G.nb[idx].r=Math.max(0,Math.min(100,G.nb[idx].r+(Math.random()<0.5?-5:5)));}
  if(G.tu>=G.mx)G.dn=1;
  G.cr=0;
  save();
  setScenarioVideo(iss.v);
  render();
}

function render(){
  document.getElementById("statsBox").innerHTML=STATS.map(s=>{const v=G.st[s.k]||s.v;return`<div class="stat-item">${s.i} ${s.n}: <b>${v}</b><div class="stat-bar"><div class="stat-fill" style="width:${v}%"></div></div></div>`;}).join("");
  document.getElementById("logBox").innerHTML=G.lg.slice(-5).reverse().map(l=>`<div>T${l.t}: ${l.ch}</div>`).join("");
  document.getElementById("cityDisplay").textContent=G.cy||"City-States Dynasty";
  document.getElementById("infoDisplay").textContent=`Turn ${G.tu}/${G.mx} ‚Ä¢ ${G.hr||"‚Äî"}`;

  if(G.dn){
    const r=ruler();const sc=score();
    submitToAirtable(G.hr, G.nm, G.cy, sc);
    document.getElementById("titleDisplay").textContent="üèÜ REIGN COMPLETE";
    document.getElementById("descDisplay").innerHTML=`<div class="final-box"><h3 class="ruler-title">${r.t}</h3><p class="ruler-desc">${r.d}</p><div class="score-num">${sc}%</div></div>`;
    document.getElementById("videoBox").classList.remove("show");
    document.getElementById("choicesBox").innerHTML=`<button class="choice-btn" onclick="openReport()"><div class="choice-title">üìã REPORT</div></button><button class="choice-btn" onclick="newGame()"><div class="choice-title">‚ñ∂ NEW</div></button>`;
    return;
  }

  let iss=G.cr?ISSUES.find(x=>x.id===G.cr):null;
  if(!iss){iss=next();if(!iss)return;G.cr=iss.id;save();}

  document.getElementById("titleDisplay").textContent=iss.t;
  document.getElementById("descDisplay").textContent=iss.d;
  setScenarioVideo(iss.v);

  document.getElementById("choicesBox").innerHTML=iss.c.map((o,i)=>{const isGeo=iss.id.startsWith("q");const d=isGeo?"":Object.entries(o.x||{}).map(([k,v])=>{const st=STATS.find(s=>s.k===k);if(!st)return"";return`<span class="impact">${st.i}${v>0?"+":""}${v}</span>`;}).join("");return`<button class="choice-btn" onclick="choose(${i})"><div class="choice-title">${o.t}</div><div class="choice-desc">${o.d}</div><div class="impacts">${d}</div></button>`;}).join("");
  
  updateLeaderboard();
}

function updateLeaderboard(){
  // Simple leaderboard showing the 4 hours
  const html = `
    <div class="lb-row"><span>1. 1st Hour</span><span>0%</span></div>
    <div class="lb-row"><span>2. 2nd Hour</span><span>0%</span></div>
    <div class="lb-row"><span>3. 5th Hour</span><span>0%</span></div>
    <div class="lb-row"><span>4. 6th Hour</span><span>0%</span></div>
  `;
  document.getElementById("leaderboardBox").innerHTML = html;
}

function newGame(){G={nm:"",cy:"",hr:"",tu:0,mx:20,dn:0,st:{},nb:[{n:"Corinth",r:50},{n:"Thebes",r:45},{n:"Sparta",r:40}],lg:[],us:[],cr:0};save();document.getElementById("setupMod").classList.add("open");}

function openReport(){const r=ruler(),sc=score(),ts=STATS.map(s=>({...s,val:G.st[s.k]||s.v}));document.getElementById("reportBox").innerHTML=`<h2 style="text-align:center;color:var(--cyan);">üèÜ ${r.t}</h2><p style="text-align:center;color:var(--pink);">${r.d}</p><p style="text-align:center;font-size:24px;color:var(--good);font-weight:700;margin:15px 0;">${sc}%</p><hr><p><b>Student:</b> ${G.nm}</p><p><b>City:</b> ${G.cy}</p><p><b>Hour:</b> ${G.hr}</p><hr><p><b>Final Stats</b></p>${ts.map(s=>`<p>${s.i} ${s.n}: ${s.val}</p>`).join("")}<p style="margin-top:12px"><b>Decisions</b></p>${G.lg.map(l=>`<p>T${l.t}: ${l.ch}</p>`).join("")}`;document.getElementById("reportMod").classList.add("open");}

document.getElementById("btnPlay").addEventListener("click",()=>{document.getElementById("titleScreen").classList.remove("active");document.getElementById("gameScreen").classList.add("active");document.getElementById("setupMod").classList.add("open");document.getElementById("bgVideo").play();});
document.getElementById("btnInfo").addEventListener("click",()=>alert("CITY-STATES DYNASTY\n\nLead your city through 20 challenges.\nMake choices that impact your realm.\nFinal score shows your ruler type!"));
document.getElementById("btnStart").addEventListener("click",()=>{const n=document.getElementById("inName").value.trim(),c=document.getElementById("inCity").value.trim(),h=document.getElementById("inHour").value;if(!n||!c){alert("Name and city required.");return;}G={nm:n,cy:c,hr:h,tu:0,mx:20,dn:0,st:{},nb:[{n:"Corinth",r:50},{n:"Thebes",r:45},{n:"Sparta",r:40}],lg:[],us:[],cr:0};norm();document.getElementById("setupMod").classList.remove("open");render();});
document.getElementById("btnLoad").addEventListener("click",()=>{if(!G.nm){alert("No save.");return;}document.getElementById("setupMod").classList.remove("open");render();});
document.getElementById("btnRpt").addEventListener("click",openReport);
document.getElementById("btnCloseReport").addEventListener("click",()=>document.getElementById("reportMod").classList.remove("open"));
document.getElementById("btnLeader").addEventListener("click",()=>document.getElementById("leaderMod").classList.add("open"));
document.getElementById("btnCloseLead").addEventListener("click",()=>document.getElementById("leaderMod").classList.remove("open"));
document.getElementById("btnDL").addEventListener("click",()=>{const r=ruler(),sc=score(),t=JSON.stringify({hour:G.hr,ruler:r.t,score:sc,student:G.nm,city:G.cy,turns:G.tu,stats:G.st,log:G.lg},null,2);const a=document.createElement("a");a.href="data:text/plain,"+encodeURIComponent(t);a.download=`city_states_${G.hr}_${G.nm}.json`;a.click();});

load();
norm();
</script>
</body>
</html>
